<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NOG â€¢ Assistente Automotivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="chat.css">

    <!-- MARKDOWN -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- DOMPurify para sanitizaÃ§Ã£o XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- ICONS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <div class="header-title">NOG â€¢ Assistente Automotivo Virtual</div>
        <div class="header-actions">
            <!-- <span class="user-name" id="userName">Carregando...</span>
            <select id="category" class="category-select">
                <option value="geral">ğŸ“Œ Geral</option>
                <option value="tecnico">ğŸ”§ TÃ©cnico</option>
                <option value="manutencao">ğŸ› ï¸ ManutenÃ§Ã£o</option>
                <option value="pecas">âš™ï¸ PeÃ§as</option>
                <option value="diagnostico">ğŸ” DiagnÃ³stico</option>
            </select> -->
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </div>

    <div class="chat-messages" id="chat"></div>

    <div class="chat-input">
        <div class="input-wrapper">
            <input 
                type="text" 
                id="input" 
                placeholder="Digite sua mensagem..." 
                maxlength="2000"
            />
            <button id="imageBtn" class="icon-btn" title="Carregar imagem">
                <i class="fas fa-image"></i>
            </button>
            <input type="file" id="imageInput" accept="image/*" />
        </div>
        <button id="sendBtn" class="icon-btn send-btn" title="Enviar mensagem">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
    <div class="char-count" id="charCount"></div>
</div>

<script>
    // ==================== CONFIG ====================
    const MAX_MESSAGE_LENGTH = 2000;
    const TOKEN_KEY = 'access_token'; // CORRIGIDO: usar mesmo nome do auth.js
    
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const imageBtn = document.getElementById("imageBtn");
    const imageInput = document.getElementById("imageInput");
    const categorySelect = document.getElementById("category");
    const charCountEl = document.getElementById("charCount");
    const userNameEl = document.getElementById("userName");
    
    let isLoading = false;
    let selectedImage = null;
    let selectedImageData = null;

    // ==================== INIT ====================
    document.addEventListener("DOMContentLoaded", () => {
        console.log('ğŸš€ Inicializando chat...');
        checkAuth();
        loadUserInfo();
        loadChatHistory();
        setupEventListeners();
    });

    // ==================== AUTENTICAÃ‡ÃƒO ====================
    function checkAuth() {
        const token = localStorage.getItem(TOKEN_KEY);
        console.log('ğŸ” Verificando token...', token ? 'Token encontrado' : 'Token nÃ£o encontrado');
        
        if (!token) {
            showError("VocÃª precisa estar autenticado. Redirecionando...");
            setTimeout(() => window.location.href = "/login", 2000);
            return;
        }

        // Validar formato do token (deve ter 3 partes)
        const parts = token.split('.');
        if (parts.length !== 3) {
            console.error('âŒ Token invÃ¡lido (nÃ£o tem 3 partes)');
            localStorage.removeItem(TOKEN_KEY);
            showError("Token invÃ¡lido. Redirecionando para login...");
            setTimeout(() => window.location.href = "/login", 2000);
            return;
        }

        console.log('âœ“ Token vÃ¡lido');
    }

    function getAuthHeaders() {
        const token = localStorage.getItem(TOKEN_KEY);
        if (!token) {
            console.error('âŒ Tentando criar headers sem token');
            return {
                "Content-Type": "application/json"
            };
        }

        console.log('ğŸ“¡ Headers criados com token');
        return {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        };
    }

    async function loadUserInfo() {
        try {
            console.log('ğŸ‘¤ Carregando informaÃ§Ãµes do usuÃ¡rio...');
            const res = await fetch("/api/user", {
                method: "GET",
                headers: getAuthHeaders()
            });

            if (res.status === 401) {
                console.error('âŒ Token expirado ou invÃ¡lido');
                handleUnauthorized();
                return;
            }

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            if (data.nome) {
                userNameEl.textContent = data.nome;
                console.log('âœ“ UsuÃ¡rio carregado:', data.nome);
            }
        } catch (err) {
            console.error('Erro ao carregar usuÃ¡rio:', err);
            userNameEl.textContent = 'UsuÃ¡rio';
        }
    }

    function handleUnauthorized() {
        showError("SessÃ£o expirada. FaÃ§a login novamente.");
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem('user_data');
        setTimeout(() => window.location.href = "/login", 2000);
    }

    async function handleLogout() {
        if (!confirm('Deseja realmente sair?')) {
            return;
        }

        try {
            // Tentar chamar API de logout
            await fetch("/api/logout", {
                method: "POST",
                headers: getAuthHeaders()
            });
        } catch (error) {
            console.error('Erro ao fazer logout:', error);
        } finally {
            // Limpar dados locais
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('user_data');
            window.location.href = "/login";
        }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        imageBtn.addEventListener("click", () => imageInput.click());
        imageInput.addEventListener("change", handleImageUpload);
        input.addEventListener("input", updateCharCount);
    }

    // ==================== CHAR COUNT ====================
    function updateCharCount() {
        const len = input.value.length;
        if (len === 0) {
            charCountEl.textContent = "";
            charCountEl.className = "char-count";
            return;
        }

        charCountEl.textContent = `${len}/${MAX_MESSAGE_LENGTH}`;
        charCountEl.className = "char-count";

        if (len > MAX_MESSAGE_LENGTH * 0.8) {
            charCountEl.classList.add("warning");
        }
        if (len >= MAX_MESSAGE_LENGTH) {
            charCountEl.classList.add("error");
        }
    }

    // ==================== IMAGENS ====================
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validar tipo
        if (!file.type.startsWith("image/")) {
            showError("Por favor, selecione uma imagem vÃ¡lida.");
            return;
        }

        // Validar tamanho (mÃ¡x 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError("A imagem nÃ£o pode exceder 5MB.");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            selectedImageData = e.target.result;
            selectedImage = file.name;
            imageBtn.style.color = "#10b981";
            imageBtn.title = `Imagem carregada: ${file.name}`;
            console.log('âœ“ Imagem carregada:', file.name);
        };
        reader.readAsDataURL(file);
    }

    // ==================== MENSAGENS ====================
    function sanitizeHTML(content) {
        // Parse markdown para HTML
        const parsed = marked.parse(content);
        
        // Sanitizar com DOMPurify (configuraÃ§Ã£o mais permissiva)
        const sanitized = DOMPurify.sanitize(parsed, {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'b', 'i', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'target', 'rel', 'class', 'style'],
            KEEP_CONTENT: true,
            RETURN_DOM: false,
            RETURN_DOM_FRAGMENT: false
        });
        
        return sanitized;
    }

    function addMessage(role, content, imageUrl = null) {
        const message = document.createElement("div");
        message.className = `message ${role}`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        
        // Adicionar wrapper para conteÃºdo
        const contentWrapper = document.createElement("div");
        contentWrapper.className = "message-content";

        if (content) {
            if (role === "ai") {
                // Log antes de processar
                console.log('ğŸ“¥ ConteÃºdo recebido:', {
                    tamanho: content.length,
                    primeiros100: content.substring(0, 100),
                    ultimos100: content.substring(content.length - 100)
                });
                
                // Renderizar markdown e sanitizar
                const htmlContent = sanitizeHTML(content);
                
                // Log apÃ³s processar
                console.log('ğŸ“¤ HTML gerado:', {
                    tamanho: htmlContent.length,
                    primeiros200: htmlContent.substring(0, 200),
                    ultimos200: htmlContent.substring(htmlContent.length - 200)
                });
                
                contentWrapper.innerHTML = htmlContent;
                
                // Verificar o que foi renderizado no DOM
                setTimeout(() => {
                    console.log('ğŸ¨ Texto final no DOM:', {
                        tamanhoTexto: bubble.textContent.length,
                        tamanhoHTML: bubble.innerHTML.length,
                        visivelNaTela: bubble.offsetHeight > 0
                    });
                }, 100);
            } else {
                contentWrapper.textContent = content;
            }
        }

        bubble.appendChild(contentWrapper);

        if (imageUrl) {
            const img = document.createElement("img");
            img.src = imageUrl;
            img.alt = "Imagem do chat";
            bubble.appendChild(img);
        }

        message.appendChild(bubble);
        chat.appendChild(message);
        
        // Scroll suave para o final
        setTimeout(() => {
            chat.scrollTop = chat.scrollHeight;
        }, 100);
    }

    function addLoadingMessage() {
        const message = document.createElement("div");
        message.className = "message loading";
        message.id = "loading-message";

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const spinner = document.createElement("div");
        spinner.className = "loading-spinner";
        spinner.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';

        bubble.appendChild(spinner);
        message.appendChild(bubble);
        chat.appendChild(message);
        chat.scrollTop = chat.scrollHeight;
    }

    function removeLoadingMessage() {
        const loadingMsg = document.getElementById("loading-message");
        if (loadingMsg) loadingMsg.remove();
    }

    // ==================== ENVIO DE MENSAGEM ====================
    async function sendMessage() {
        const text = input.value.trim();
        
        if (!text && !selectedImageData) {
            showError("Digite uma mensagem ou selecione uma imagem.");
            return;
        }

        if (text.length > MAX_MESSAGE_LENGTH) {
            showError(`Mensagem muito longa (mÃ¡x ${MAX_MESSAGE_LENGTH} caracteres).`);
            return;
        }

        if (isLoading) return;

        // Mostrar mensagem do usuÃ¡rio
        addMessage("user", text || "(Imagem enviada)", selectedImageData);
        
        const messageToSend = text;
        const imageToSend = selectedImageData;
        
        // Limpar inputs
        input.value = "";
        selectedImage = null;
        selectedImageData = null;
        imageBtn.style.color = "";
        imageBtn.title = "Carregar imagem";
        updateCharCount();

        isLoading = true;
        sendBtn.disabled = true;
        addLoadingMessage();

        try {
            console.log('ğŸ“¤ Enviando mensagem...');
            
            const payload = {
                message: messageToSend,
                category: categorySelect.value
            };

            if (imageToSend) {
                payload.image = imageToSend;
            }

            const res = await fetch("/api/chat", {
                method: "POST",
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            });

            removeLoadingMessage();

            // Tratamento de erros HTTP
            if (!res.ok) {
                if (res.status === 401) {
                    handleUnauthorized();
                    return;
                } else if (res.status === 403) {
                    showError("VocÃª nÃ£o tem permissÃ£o para acessar este recurso.");
                    addMessage("error", "âŒ Acesso negado.");
                    return;
                } else if (res.status === 429) {
                    showError("Muitas requisiÃ§Ãµes. Aguarde um momento.");
                    addMessage("error", "âŒ Limite de requisiÃ§Ãµes atingido. Aguarde alguns instantes.");
                    return;
                }
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            console.log('âœ“ Resposta recebida:', data);
            console.log('ğŸ“Š AnÃ¡lise da resposta:', {
                sucesso: data.success,
                temResponse: !!data.response,
                temText: !!data.text,
                tamanhoResponse: data.response?.length || 0,
                tamanhoText: data.text?.length || 0,
                tipo: data.tipo
            });

            // Verificar resposta
            if (data.error) {
                addMessage("error", `âŒ Erro: ${data.error}`);
                return;
            }

            // Adaptar resposta para diferentes formatos
            const responseText = data.response || data.text || "NÃ£o consegui gerar resposta.";
            const responseImage = data.image || null;

            console.log('ğŸ“ Texto que serÃ¡ adicionado:', {
                tamanho: responseText.length,
                inicio: responseText.substring(0, 100),
                fim: responseText.substring(responseText.length - 100)
            });

            addMessage("ai", responseText, responseImage);
            console.log('âœ“ Mensagem adicionada ao chat');

        } catch (err) {
            removeLoadingMessage();
            console.error("âŒ Erro:", err);
            addMessage("error", `âŒ Erro ao se comunicar com o servidor: ${err.message}`);
        } finally {
            isLoading = false;
            sendBtn.disabled = false;
        }
    }

    // ==================== HISTÃ“RICO ====================
    async function loadChatHistory() {
        try {
            console.log('ğŸ“œ Carregando histÃ³rico...');
            
            const res = await fetch("/api/chat/history", {
                method: "GET",
                headers: getAuthHeaders()
            });

            if (res.status === 401) {
                handleUnauthorized();
                return;
            }

            if (!res.ok) {
                console.warn('Erro ao carregar histÃ³rico:', res.status);
                return;
            }

            const data = await res.json();
            console.log('HistÃ³rico recebido:', data);

            if (data.chats && Array.isArray(data.chats) && data.chats.length > 0) {
                console.log(`âœ“ ${data.chats.length} mensagens carregadas`);
                
                data.chats.forEach(item => {
                    addMessage("user", item.mensagem_usuario);
                    addMessage("ai", item.resposta_ia);
                });
            } else {
                console.log('Nenhum histÃ³rico encontrado');
            }
        } catch (err) {
            console.warn("Erro ao carregar histÃ³rico:", err);
        }
    }

    // ==================== NOTIFICAÃ‡Ã•ES ====================
    function showError(message) {
        console.error('âŒ', message);
        
        const toast = document.createElement("div");
        toast.className = "error-toast";
        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = "slideInRight 0.3s ease-out reverse";
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // Log inicial
    console.log('ğŸ” Estado da autenticaÃ§Ã£o:');
    console.log('Token presente:', !!localStorage.getItem(TOKEN_KEY));
    console.log('UsuÃ¡rio:', localStorage.getItem('user_data'));
</script>

</body>
</html>